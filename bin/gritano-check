#!/usr/bin/env ruby

$:.unshift File.join(File.dirname(__FILE__), *%w[.. lib])

require 'gritano'

ActiveRecord::Base.establish_connection(YAML::load(File.open(File.join(Etc.getpwuid.dir, '.gritano', 'database.yml'))))

login = ARGV[0]
command = Gritano::Command.eval(ENV['SSH_ORIGINAL_COMMAND'])
user = Gritano::User.find_by_login(login)
case command[:access]
  when :read, :write then
    repository = Gritano::Repository.find_by_name(command[:repo])
    if user and repository
      if user.check_access(repository, command[:access])
        exec "#{command[:command]} #{File.join(repository.full_path)}"
      end
    end
end