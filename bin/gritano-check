#!/usr/bin/env ruby

$:.unshift File.join(File.dirname(__FILE__), *%w[.. lib])

require 'gritano'

def help
  puts "
  ssh user@host command
  
  Examples:
  ssh git@host.com repo:list
  ssh git@host.com key:list
  ssh git@host.com key:add keyname < key.pub
  ssh git@host.com key:rm keyname
  ssh git@host.com admin:help
  
  --
  v#{File.open(File.join(File.dirname(__FILE__), '..', 'VERSION')).readlines.join}"
end

ActiveRecord::Base.establish_connection(YAML::load(File.open(File.join(Etc.getpwuid.dir, '.gritano', 'database.yml'))))

login = ARGV[0]
command = Gritano::Command.eval(ENV['SSH_ORIGINAL_COMMAND'])
begin
  case command[:access]
    when :read, :write then
      Gritano::CLI::git(command[:command], Gritano::User.find_by_login(login), Gritano::Repository.find_by_name(command[:repo]))
    when :user_cmd
      Gritano::CLI::execute(command[:command].gsub("[USER]", login).split(' '), STDIN)
    when :admin_cmd
      Gritano::CLI::execute_admin(command[:command].split(' '), STDIN, Gritano::User.find_by_login(login))
  end
rescue
  puts help
end
