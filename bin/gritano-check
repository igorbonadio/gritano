#!/usr/bin/env ruby

$:.unshift File.join(File.dirname(__FILE__), *%w[.. lib])

require 'gritano'

def help
  puts "
  ssh user@host command
  
  Examples:
  ssh git@host.com repos
  ssh git@host.com keys
  ssh git@host.com key add keyname < key.pub
  ssh git@host.com key rm keyname
  
  --
  v#{File.open(File.join(File.dirname(__FILE__), '..', 'VERSION')).readlines.join}"
end

ActiveRecord::Base.establish_connection(YAML::load(File.open(File.join(Etc.getpwuid.dir, '.gritano', 'database.yml'))))

login = ARGV[0]
command = Gritano::Command.eval(ENV['SSH_ORIGINAL_COMMAND'])
begin
  case command[:access]
    when :read, :write then
      user = Gritano::User.find_by_login(login)
      repository = Gritano::Repository.find_by_name(command[:repo])
      if user and repository
        if user.check_access(repository, command[:access])
          exec "#{command[:command]} #{File.join(repository.full_path)}"
        end
      end
    when :user_cmd
      cmd = command[:command]
      if cmd.start_with? "+key" or cmd.start_with? "-key"
        tmp = cmd.split(" ")
        tmp = tmp[0..-2] + [login] + tmp[-1..-1]
        cmd = tmp.join(" ")
      else
        cmd = cmd + " " + login
      end
      exec "gritano user #{cmd}"
  end
rescue
  puts help
end